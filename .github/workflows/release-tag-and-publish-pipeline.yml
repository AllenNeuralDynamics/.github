# Automatic semantic versioning workflow
# Uses conventional commits to determine version bumps:
#   - feat: -> minor version bump (0.1.0 -> 0.2.0)
#   - fix:  -> patch version bump (0.1.0 -> 0.1.1)
#   - BREAKING CHANGE or feat!: or fix!: -> major version bump (0.1.0 -> 1.0.0)
#   - chore:, docs:, style:, refactor:, test: -> no version bump

name: Version Bump

on:
  workflow_call:
    inputs:
      bump_type:
        description: 'Version bump type (leave empty for auto-detection from commits)'
        required: false
        type: string
        default: ''

jobs:
  version-bump:
    name: Bump version and update config
    if: >-
      github.event_name == 'workflow_call' ||
      (!contains(github.event.head_commit.message || '', '[skip ci]') &&
       !contains(github.event.head_commit.message || '', '[skip actions]'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Conventional Changelog Action
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          skip-version-file: 'true'
          output-file: 'CHANGELOG.md'
          skip-commit: 'true'
          skip-tag: 'true'
          skip-on-empty: 'true'
          fallback-version: '0.1.0'

      - name: Update nextflow.config
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        run: |
          NEW_VERSION="${{ steps.changelog.outputs.version }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          REPO_NAME="${{ github.event.repository.name }}"
          CONFIG_FILE="pipeline/nextflow.config"
          
          # Check if env block exists
          if grep -q "^env {" "$CONFIG_FILE"; then
            # Update existing PIPELINE_NAME if it exists
            if grep -q "PIPELINE_NAME" "$CONFIG_FILE"; then
              sed -i "s/PIPELINE_NAME = .*/PIPELINE_NAME = \"$REPO_NAME\"/" "$CONFIG_FILE"
            else
              # Add PIPELINE_NAME to existing env block
              sed -i "/^env {/a\\    PIPELINE_NAME = \"$REPO_NAME\"" "$CONFIG_FILE"
            fi
            
            # Update existing PIPELINE_VERSION if it exists
            if grep -q "PIPELINE_VERSION" "$CONFIG_FILE"; then
              sed -i "s/PIPELINE_VERSION = .*/PIPELINE_VERSION = \"$NEW_VERSION\"/" "$CONFIG_FILE"
            else
              # Add PIPELINE_VERSION to existing env block
              sed -i "/^env {/a\\    PIPELINE_VERSION = \"$NEW_VERSION\"" "$CONFIG_FILE"
            fi
            
            # Update existing PIPELINE_URL if it exists
            if grep -q "PIPELINE_URL" "$CONFIG_FILE"; then
              sed -i "s|PIPELINE_URL = .*|PIPELINE_URL = \"$REPO_URL\"|" "$CONFIG_FILE"
            else
              # Add PIPELINE_URL to existing env block
              sed -i "/^env {/a\\    PIPELINE_URL = \"$REPO_URL\"" "$CONFIG_FILE"
            fi
          else
            # Add env block at the end of the file
            echo "" >> "$CONFIG_FILE"
            echo "env {" >> "$CONFIG_FILE"
            echo "    PIPELINE_NAME = \"$REPO_NAME\"" >> "$CONFIG_FILE"
            echo "    PIPELINE_VERSION = \"$NEW_VERSION\"" >> "$CONFIG_FILE"
            echo "    PIPELINE_URL = \"$REPO_URL\"" >> "$CONFIG_FILE"
            echo "}" >> "$CONFIG_FILE"
          fi
          
          echo "Updated $CONFIG_FILE with name $REPO_NAME, version $NEW_VERSION and URL $REPO_URL"
          cat "$CONFIG_FILE"

      - name: Commit and push version bump
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        uses: EndBug/add-and-commit@v9
        with:
          default_author: github_actions
          message: "ci: bump version to ${{ steps.changelog.outputs.version }} [skip ci]"
          add: |
            pipeline/nextflow.config
            CHANGELOG.md

      - name: Create and push tag
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        run: |
          git tag -a "${{ steps.changelog.outputs.tag }}" -m "Release ${{ steps.changelog.outputs.tag }}"
          git push origin "${{ steps.changelog.outputs.tag }}"
          echo "✅ Created and pushed tag: ${{ steps.changelog.outputs.tag }}"

      - name: Create GitHub Release
        if: ${{ steps.changelog.outputs.skipped == 'false' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.changelog.outputs.tag }}
          name: Release ${{ steps.changelog.outputs.tag }}
          body: ${{ steps.changelog.outputs.clean_changelog }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: No version bump needed
        if: ${{ steps.changelog.outputs.skipped == 'true' }}
        run: |
          echo "ℹ️ No version bump needed based on commit messages."
          echo "To trigger a version bump, use conventional commit prefixes:"
          echo "  - feat: for new features (minor bump)"
          echo "  - fix: for bug fixes (patch bump)"
          echo "  - feat!: or BREAKING CHANGE for breaking changes (major bump)"